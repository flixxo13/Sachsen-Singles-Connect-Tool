-- ════════════════════════════════════════════════════════════════
--  SACHSEN SINGLES — fix2.sql
--  Im Supabase SQL-Editor ausführen (einmalig, nach fix.sql)
-- ════════════════════════════════════════════════════════════════

-- 1. IP-Adresse Spalte zu profiles hinzufügen
ALTER TABLE public.profiles
  ADD COLUMN IF NOT EXISTS ip_address TEXT;

-- 2. Rate-Limit Prüfung: max. 2 Profile pro IP innerhalb 24 Stunden
--    Wird vom Frontend VOR dem Insert aufgerufen
CREATE OR REPLACE FUNCTION public.check_ip_rate(p_ip TEXT)
RETURNS JSON LANGUAGE plpgsql SECURITY DEFINER AS $$
DECLARE profile_count INTEGER;
BEGIN
  -- Leere oder unbekannte IPs nicht blockieren
  IF p_ip IS NULL OR p_ip = '' OR p_ip = 'unknown' THEN
    RETURN json_build_object('ok', true, 'allowed', true);
  END IF;

  SELECT COUNT(*) INTO profile_count
  FROM profiles
  WHERE ip_address = p_ip
    AND created_at > NOW() - INTERVAL '24 hours';

  IF profile_count >= 2 THEN
    RETURN json_build_object(
      'ok', true,
      'allowed', false,
      'count', profile_count
    );
  END IF;

  RETURN json_build_object('ok', true, 'allowed', true, 'count', profile_count);
END;
$$;

-- ════════════════════════════════════════════════════════════════
--  FERTIG — index.html ebenfalls aktualisieren
-- ════════════════════════════════════════════════════════════════
